<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COVID-19 Excess Deaths - Martini Glass Narrative</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f8f8f8;
      color: #333;
    }
    .container {
      padding: 40px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    .scene {
      margin: 60px 0;
    }
    .chart {
      margin-top: 20px;
    }
    .button-container {
      text-align: center;
      margin-top: 30px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    svg {
      width: 100%;
      height: 400px;
      background-color: white;
      border: 1px solid #ccc;
    }
    .axis-label {
      font-size: 12px;
      fill: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Excess Mortality During COVID-19</h1>
    <div id="scene-1" class="scene">
      <h2>Scene 1: Global Trend in Excess Deaths</h2>
      <p>Notice that a large group of countries reported low amounts of casualties
         per 100k reported excess deaths. This is likely because resources that were
         allocated for COVID patient couldn't be given to patients that would otherwise
         be there with other illnesses and health complications.</p>
      <div class="chart" id="chart1"></div>
    </div>

    <div id="scene-2" class="scene" style="display:none;">
      <h2>Scene 2: Country Spotlight - United States</h2>
      <p>Here we highlight the trajectory of excess mortality in the U.S compared to
         it's confirmed deaths. We can see that as time progresses and more COVID deaths
         are confirmed, the disparity between the excess deaths grows wider. This shows
         greater evidence that COVID took resources that would be allocated to other patients,
         resulting in an increased rate of fatality of other hospitalized individuals.<br><br>This
         could also be the result of people who had underlying conditions that weren't fatal
         beforehand succumbing to a further attack brought on by COVID.</p>
      <div class="chart" id="chart2"></div>
    </div>

    <div id="scene-3" class="scene" style="display:none;">
      <h2>Scene 3: Compare Countries</h2>
      <p>Select a country to explore its excess death trends. Notice how, like the previously
         shown US graph, most of these countries experience a higher number of excess deaths over time,
         even if the confirmed COVID deaths don't increase that quickly.
      </p>
      <select id="countrySelect"></select>
      <div class="chart" id="chart3"></div>
    </div>

    <div class="button-container">
      <button id="backBtn" disabled>Back</button>
      <button id="nextBtn">Next</button>
    </div>
  </div>

  <script>
    let sceneIndex = 1;

    const maxScenes = 3;
    const backBtn = document.getElementById("backBtn");
    const nextBtn = document.getElementById("nextBtn");

    function updateScene(direction) {
      document.getElementById(`scene-${sceneIndex}`).style.display = "none";
      sceneIndex += direction;
      document.getElementById(`scene-${sceneIndex}`).style.display = "block";

      backBtn.disabled = sceneIndex === 1;
      nextBtn.disabled = sceneIndex === maxScenes;
    }

    backBtn.addEventListener("click", () => updateScene(-1));
    nextBtn.addEventListener("click", () => updateScene(1));

    d3.csv("cleaned_excess_deaths.csv").then(data => {
      console.log("Loaded data:", data);
      data.forEach(d => {
        d.date = new Date(d.date);
        d.excess_deaths = +d.excess_deaths;
        d.excess_mortality = +d.excess_mortality;
      });

      // SCENE 1: Global Median Excess Mortality
      const scatterData = data
        .filter(d => !isNaN(d.excess_mortality) && !isNaN(d.confirmed_deaths))
        .map(d => ({
          x: +d.excess_mortality,
          y: +d.confirmed_deaths,
          location: d.location,
          date: d.date
        }));
      drawScatterPlot(scatterData, "chart1", "Excess Mortality vs Confirmed Deaths");

      // SCENE 2: US Spotlight
      d3.csv("cleaned_us_excess_deaths.csv", d3.autoType).then(data => {
        drawDualLineChart(data, "chart2", "US: Excess vs. Confirmed COVID-19 Deaths Over Time");
      });

      // SCENE 3: Select Country
      d3.csv("cleaned_excess_mortality_data.csv", d3.autoType).then(scene3Data => {
        // Convert date and numeric fields
        scene3Data.forEach(d => {
          d.date = new Date(d.date);
          d.excess_mortality = +d.excess_mortality;
          d.confirmed_deaths = +d.confirmed_deaths;
        });

        // Populate country dropdown
        const countries = Array.from(new Set(scene3Data.map(d => d.location))).sort();
        const select = d3.select("#countrySelect");
        select.selectAll("option")
          .data(countries)
          .enter()
          .append("option")
          .text(d => d);

        // Initial draw (optional: set default country)
        const defaultCountry = countries.includes("United States") ? "United States" : countries[0];
        select.property("value", defaultCountry);
        updateScene3Chart(defaultCountry);

        // Update chart on dropdown change
        select.on("change", function () {
          updateScene3Chart(this.value);
        });

        function updateScene3Chart(country) {
        const countryData = scene3Data
          .filter(d =>
            d.location === country &&
            d.date instanceof Date &&
            !isNaN(d.date) &&
            !isNaN(d.excess_mortality) &&
            !isNaN(d.confirmed_deaths)
          )
          .map(d => ({
            date: d.date,
            excess_mortality: d.excess_mortality,
            confirmed_deaths: d.confirmed_deaths
          }));

        drawDualLineChart(countryData, "chart3", `${country}: Excess vs Confirmed Deaths Over Time`);
      }
      });
    });

    function drawDualLineChart(data, containerId, title) {
      const container = d3.select(`#${containerId}`);
      container.selectAll("*").remove(); // Clear previous contents

      const margin = { top: 40, right: 30, bottom: 50, left: 60 };
      const width = 800 - margin.left - margin.right;
      const height = 400 - margin.top - margin.bottom;

      const svg = container.append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      // Convert strings to appropriate types
      const formattedData = data.map(d => ({
        date: new Date(d.date),
        excess: +d.excess_mortality,
        confirmed: +d.confirmed_deaths
      }));

      // Scales
      const x = d3.scaleTime()
        .domain(d3.extent(formattedData, d => d.date))
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(formattedData, d => Math.max(d.excess, d.confirmed))]).nice()
        .range([height, 0]);

      // Axes
      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(6));

      svg.append("g")
        .call(d3.axisLeft(y));

      // Line generators
      const lineExcess = d3.line()
        .x(d => x(d.date))
        .y(d => y(d.excess));

      const lineConfirmed = d3.line()
        .x(d => x(d.date))
        .y(d => y(d.confirmed));

      // Draw lines
      svg.append("path")
        .datum(formattedData)
        .attr("fill", "none")
        .attr("stroke", "red")
        .attr("stroke-width", 2)
        .attr("d", lineExcess);

      svg.append("path")
        .datum(formattedData)
        .attr("fill", "none")
        .attr("stroke", "blue")
        .attr("stroke-width", 2)
        .attr("d", lineConfirmed);

      // Labels
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", -10)
        .attr("text-anchor", "middle")
        .attr("font-size", "16px")
        .text(title);

      // Legend
      const legend = svg.append("g")
        .attr("transform", `translate(${width - 150}, 10)`);

      legend.append("rect")
        .attr("x", 0)
        .attr("y", 260)
        .attr("width", 10)
        .attr("height", 10)
        .attr("fill", "red");

      legend.append("text")
        .attr("x", 15)
        .attr("y", 265)
        .text("Excess Deaths")
        .style("font-size", "12px")
        .attr("alignment-baseline", "middle");

      legend.append("rect")
        .attr("x", 0)
        .attr("y", 280)
        .attr("width", 10)
        .attr("height", 10)
        .attr("fill", "blue");

      legend.append("text")
        .attr("x", 15)
        .attr("y", 285)
        .text("Confirmed Deaths")
        .style("font-size", "12px")
        .attr("alignment-baseline", "middle");
    }


    function drawScatterPlot(data, containerId, title) {
      d3.select(`#${containerId}`).selectAll("svg").remove();

      const margin = { top: 30, right: 30, bottom: 50, left: 60 },
            width = 800 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

      const svg = d3.select(`#${containerId}`)
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scaleLinear()
        .domain(d3.extent(data, d => d.x))
        .nice()
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain(d3.extent(data, d => d.y))
        .nice()
        .range([height, 0]);

      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));
      svg.append("text")
        .attr("class", "axis-label")
        .attr("x", width / 2)
        .attr("y", height + 40)
        .attr("text-anchor", "middle")
        .text("Excess Mortality per 100k");

      svg.append("g")
        .call(d3.axisLeft(y));
      svg.append("text")
        .attr("class", "axis-label")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y", -45)
        .attr("text-anchor", "middle")
        .text("Confirmed Deaths per 100k");

      svg.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("cx", d => x(d.x))
        .attr("cy", d => y(d.y))
        .attr("r", 4)
        .attr("fill", "steelblue")
        .attr("opacity", 0.6);

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", -10)
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        .text(title);
    }
  </script>
</body>
</html>