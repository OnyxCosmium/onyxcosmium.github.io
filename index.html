<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COVID Excess Deaths Narrative</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    .chart {
      margin-bottom: 50px;
    }
    svg {
      width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>
  <h1>Excess Deaths During COVID-19</h1>

  <div class="chart" id="chart1">
    <h2>Global Median Excess Deaths per 100k</h2>
    <svg></svg>
  </div>

  <div class="chart" id="chart2">
    <h2>United States: Excess Deaths per 100k</h2>
    <svg></svg>
  </div>

  <div class="chart" id="chart3">
    <h2>Select a Country</h2>
    <select id="countrySelect"></select>
    <svg></svg>
  </div>

  <script>
    d3.csv("cleaned_excess_deaths.csv").then(data => {
      data.forEach(d => {
        d.date = new Date(d.date);
        d.excess_mortality = +d.excess_mortality;
      });

      const parseDate = d3.timeParse("%Y-%m-%d");
      data.forEach(d => {
        d.date = parseDate(d.date);
      });

      // Scene 1: Global Median Excess Mortality
      const nestedByDate = d3.rollup(
        data,
        v => d3.median(v, d => d.excess_mortality),
        d => d.date
      );
      const globalData = Array.from(nestedByDate, ([date, value]) => ({ date, value }));
      drawLineChart(globalData, "chart1", "Global Median Excess Deaths per 100k");

      // Scene 2: United States
      const usData = data.filter(d => d.location === "United States")
                         .map(d => ({ date: d.date, value: d.excess_mortality }));
      drawLineChart(usData, "chart2", "United States: Excess Deaths per 100k");

      // Scene 3: Dropdown Country Selection
      const countries = Array.from(new Set(data.map(d => d.location))).sort();
      const select = d3.select("#countrySelect");
      select.selectAll("option")
        .data(countries)
        .enter()
        .append("option")
        .text(d => d);

      select.on("change", function() {
        const selected = this.value;
        const countryData = data.filter(d => d.location === selected)
                                 .map(d => ({ date: d.date, value: d.excess_mortality }));
        drawLineChart(countryData, "chart3", `${selected}: Excess Deaths per 100k`);
      });
    });

    function drawLineChart(data, containerId, label) {
      const svg = d3.select(`#${containerId} svg`);
      svg.selectAll("*").remove();

      const width = svg.node().clientWidth;
      const height = svg.node().clientHeight;
      const margin = { top: 20, right: 30, bottom: 40, left: 60 };

      const x = d3.scaleTime()
                  .domain(d3.extent(data, d => d.date))
                  .range([margin.left, width - margin.right]);

      const y = d3.scaleLinear()
                  .domain([0, d3.max(data, d => d.value)]).nice()
                  .range([height - margin.bottom, margin.top]);

      const line = d3.line()
                     .x(d => x(d.date))
                     .y(d => y(d.value));

      svg.append("g")
         .attr("transform", `translate(0,${height - margin.bottom})`)
         .call(d3.axisBottom(x));

      svg.append("g")
         .attr("transform", `translate(${margin.left},0)`)
         .call(d3.axisLeft(y));

      svg.append("path")
         .datum(data)
         .attr("fill", "none")
         .attr("stroke", "steelblue")
         .attr("stroke-width", 1.5)
         .attr("d", line);
    }
  </script>
</body>
</html>
